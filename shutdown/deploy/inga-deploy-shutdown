#!/usr/bin/env bash
# /usr/local/sbin/inga-deploy-shutdown
# Deploys SHUTDOWN scripts from the inga-quants repo to /srv/inga/SHUTDOWN/bin/
# and installs the systemd drop-in for inga-weekly-digest.
#
# Designed to run as root via NOPASSWD sudo so Claude Code and VSCode tasks
# can deploy without interactive password prompts.
#
# One-time setup (as root):
#   sudo cp shutdown/deploy/inga-deploy-shutdown /usr/local/sbin/
#   sudo chown root:root /usr/local/sbin/inga-deploy-shutdown
#   sudo chmod 755 /usr/local/sbin/inga-deploy-shutdown
#   sudo cp shutdown/deploy/inga-sudoers-deploy /etc/sudoers.d/inga-deploy-shutdown
#   sudo chmod 440 /etc/sudoers.d/inga-deploy-shutdown
#   sudo visudo -c   # validate
#
# After setup, deploy with:
#   sudo inga-deploy-shutdown
set -euo pipefail

REPO="${REPO:-/srv/inga-quants}"
SRC="$REPO/shutdown"
DEST=/srv/inga/SHUTDOWN/bin
SYSTEMD_DROP=/etc/systemd/system/inga-weekly-digest.service.d

_ts() { date -u +%Y-%m-%dT%H:%M:%SZ; }
_log() { echo "$(_ts) $*"; }

_log "inga-deploy-shutdown: start"

# ── scripts ──────────────────────────────────────────────────────────────────
for script in \
  inga_market_quotes_ingest_jq300.sh \
  inga_universe300_build.sh \
  inga_weekly_digest_wrapper.sh
do
  src_file="$SRC/bin/$script"
  if [[ ! -f "$src_file" ]]; then
    _log "WARN: $src_file not found — skipping"
    continue
  fi
  bash -n "$src_file" || { _log "ERR: syntax check failed for $script"; exit 1; }
  cp "$src_file" "$DEST/$script"
  chmod 750 "$DEST/$script"
  _log "  deployed: $DEST/$script"
done

# ── notify_digest.py ─────────────────────────────────────────────────────────
NOTIFY_SRC="$SRC/tools/notify_digest.py"
if [[ -f "$NOTIFY_SRC" ]]; then
  cp "$NOTIFY_SRC" "$DEST/notify_digest.py"
  chmod 640 "$DEST/notify_digest.py"
  _log "  deployed: $DEST/notify_digest.py"
else
  _log "WARN: $NOTIFY_SRC not found — skipping notify_digest.py"
fi

# ── systemd drop-in ──────────────────────────────────────────────────────────
OVERRIDE_SRC="$SRC/systemd/inga-weekly-digest.service.d/skip-wrapper.conf"
if [[ -f "$OVERRIDE_SRC" ]]; then
  mkdir -p "$SYSTEMD_DROP"
  cp "$OVERRIDE_SRC" "$SYSTEMD_DROP/skip-wrapper.conf"
  _log "  deployed: $SYSTEMD_DROP/skip-wrapper.conf"
  systemctl daemon-reload
  systemctl reset-failed inga-weekly-digest.service 2>/dev/null || true
  _log "  systemd daemon-reload OK"
fi

_log "inga-deploy-shutdown: OK"
